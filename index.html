<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>éå¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾èª¿æŸ¥ Â· é¦¬å¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾å¤§æœæŸ¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-top: #fee2e2;
      --bg-mid: #f97316;
      --bg-bottom: #7f1d1d;
      --panel: #fff7ed;
      --border: #fed7aa;
      --accent: #f97316;
      --accent-strong: #ea580c;
      --accent-soft: rgba(248, 113, 113, 0.15);
      --text: #3f1d1d;
      --muted: #9f1239;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      /* å›ºå®šæ•´é æ·±ç´…åº•è‰²ï¼Œé¿å…åº•éƒ¨å†é•·å‡ºä¸€å¡Šä¸åŒé¡è‰² */
      background: var(--bg-bottom);
      color: var(--text);
      font-size: 17px;
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px 16px 40px;
      position: relative;
      /* åœ¨æ·±ç´…åº•ä¸Šç–Šä¸€å±¤è¼•å¾®æ©˜è‰²æ¼¸å±¤ï¼Œæ•´é«”ä¸€è‡´ */
      background: radial-gradient(circle at top, var(--bg-top) 0, var(--bg-mid) 50%, var(--bg-bottom) 100%);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
    }

    .hero-strip {
      margin-bottom: 10px;
    }
    .hero-banner-wrap {
      position: relative;
      overflow: hidden;
      border-radius: 18px;
      box-shadow: 0 16px 32px rgba(0,0,0,.5);
      border: 1px solid rgba(248, 250, 252, .4);
    }
    .hero-banner {
      display: block;
      width: 100%;
      height: auto;
    }
    .hero-text-block {
      margin-top: 10px;
      color: #fef2f2;
    }
    .hero-title {
      font-size: 22px;
      font-weight: 800;
      margin: 0 0 4px;
    }
    .hero-sub {
      font-size: 14px;
      opacity: .95;
    }

    .layout {
      display: grid;
      gap: 18px;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, .8fr);
      align-items: flex-start;
    }
    @media (max-width: 840px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 18px 20px 20px;
      box-shadow: 0 16px 34px rgba(127, 29, 29, 0.35);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(254, 243, 199, .6), transparent 60%);
      opacity: 0.75;
      pointer-events: none;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 22px;
      position: relative;
      z-index: 1;
    }

    .progress-shell { margin-bottom: 14px; position: relative; z-index: 1; }
    .progress-track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #fee2e2;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, #fb923c, #facc15);
      transition: width 0.35s ease-out;
    }

    label {
      display: block;
      margin: 14px 0 6px;
      font-size: 17px;
      position: relative;
      z-index: 1;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 12px 13px;
      border-radius: 12px;
      border: 1px solid #fed7aa;
      background: #fff7f7;
      color: var(--text);
      font-size: 16px;
      transition: box-shadow 0.2s ease, transform 0.08s ease;
      position: relative;
      z-index: 1;
    }
    select:focus, input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.7);
      transform: translateY(-1px);
    }

    .money-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .money-row select {
      flex: 0 0 80px;
    }
    .money-row input[type="text"] {
      flex: 1;
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px 14px;
      margin-top: 8px;
      position: relative;
      z-index: 1;
    }
    @media (max-width: 600px) {
      .game-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .game-card {
      position: relative;
      padding: 10px 10px 9px;
      border-radius: 14px;
      border: 1px solid #fed7aa;
      background: #fff7f5;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
    }
    .game-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(248, 113, 113, 0.35);
    }
    .game-card.selected {
      border-color: #f97316;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.6);
      background: #fff1e6;
      transform: translateY(-2px) scale(1.01);
    }
    .game-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: #fee2e2;
    }
    .game-text-title {
      font-size: 15px;
      font-weight: 600;
    }

    .hint {
      font-size: 14px;
      color: var(--muted);
      position: relative;
      z-index: 1;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      position: relative;
      z-index: 1;
    }
    .nav-buttons button { flex: 1; }
    .nav-buttons .back {
      background: #fee2e2;
      color: #9f1239;
      box-shadow: none;
    }

    button {
      margin-top: 20px;
      width: 100%;
      padding: 13px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, #f97316, #facc15);
      color: #450a0a;
      font-weight: 800;
      font-size: 17px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(248, 250, 252, 0.25);
      transition: transform 0.09s ease, box-shadow 0.09s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(248, 250, 252, 0.35);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
    }
    button:disabled {
      opacity: .6;
      cursor: wait;
    }

    .badge-title {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #fef3c7;
      background: linear-gradient(90deg, #b91c1c, #f97316);
      margin-bottom: 10px;
    }
    .result-tag {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, #facc15, #fb923c);
      color: #451a03;
      font-weight: 800;
    }
    .confetti-row {
      margin-top: 8px;
      font-size: 20px;
    }

    .result-main {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .result-detail {
      font-size: 15px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .result-banner {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--accent-soft);
      border: 1px solid rgba(248,113,113,.5);
      font-size: 16px;
    }

    .type-row {
      display: flex;
      gap: 12px;
      margin-top: 10px;
    }
    .type-col {
      flex: 1;
    }
    .type-section-title {
      font-size: 14px;
      font-weight: 700;
      color: #7f1d1d;
    }
    .type-label-big {
      display: inline-block;
      margin-top: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #fbbf24, #f97316);
      color: #451a03;
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .08em;
    }

    .result-image-wrap {
      margin: 10px auto 4px;
      max-width: 210px;
    }
    .result-type-img {
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 10px 20px rgba(0,0,0,.4);
      display: block;
    }

    .result-actions {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .result-actions button {
      flex: 1;
      min-width: 140px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }

    .warning-bottom {
      margin-top: 18px;
      font-size: 13px;
      color: #fecaca;
      background: rgba(0,0,0,.35);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(248,250,252,.2);
    }

    .step { display: none; }
    .step.active { display: block; animation: fadeIn 0.25s ease-out; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="hero-strip">
    <div class="hero-banner-wrap">
      <img src="img/Banner.PNG" alt="é¦¬å¹´åˆ®åˆ®æ¨‚" class="hero-banner">
    </div>
    <div class="hero-text-block">
      <div class="hero-title">é¦¬å¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾å¤§æœæŸ¥</div>
      <div class="hero-sub">å¡«å®Œ 1 åˆ†é˜ï¼Œçœ‹çœ‹æ‚¨æ˜¯è²¡ç¥ã€è´ŠåŠ©å•†ï¼Œé‚„æ˜¯ç©©å¥å›æœ¬ä»”ã€‚</div>
    </div>
  </div>

  <div class="layout">
    <section class="card" id="form-card">
      <h2>å¡«å¯«æ‚¨çš„éå¹´åˆ®åˆ®æ¨‚æˆ°å ±</h2>
      <div class="progress-shell">
        <div class="progress-track"><div class="progress-bar" id="progress-bar"></div></div>
      </div>
      <form id="survey-form">
        <!-- Step 1: Age -->
        <div class="step active" data-step="1">
          <label for="age">æ‚¨å¹¾æ­²ï¼Ÿ</label>
          <select id="age" name="age" required>
            <option value="" disabled selected>è«‹é¸æ“‡å¹´é½¡å€é–“ï¼ˆåƒ…é™ 18 æ­²ä»¥ä¸Šï¼‰</option>
            <option>18â€“24 æ­²</option>
            <option>25â€“34 æ­²</option>
            <option>35â€“44 æ­²</option>
            <option>45â€“54 æ­²</option>
            <option>55â€“64 æ­²</option>
            <option>65 æ­²ä»¥ä¸Š</option>
          </select>
          <div class="nav-buttons">
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 2: City -->
        <div class="step" data-step="2">
          <label for="city">æ‚¨åœ¨å“ªè£¡éå¹´ï¼Ÿ</label>
          <select id="city" name="city" required>
            <option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>
            <option>å°åŒ—å¸‚</option><option>æ–°åŒ—å¸‚</option><option>åŸºéš†å¸‚</option>
            <option>æ¡ƒåœ’å¸‚</option><option>æ–°ç«¹å¸‚</option><option>æ–°ç«¹ç¸£</option>
            <option>è‹—æ —ç¸£</option><option>å°ä¸­å¸‚</option><option>å½°åŒ–ç¸£</option>
            <option>å—æŠ•ç¸£</option><option>é›²æ—ç¸£</option><option>å˜‰ç¾©å¸‚</option><option>å˜‰ç¾©ç¸£</option>
            <option>å°å—å¸‚</option><option>é«˜é›„å¸‚</option><option>å±æ±ç¸£</option>
            <option>å®œè˜­ç¸£</option><option>èŠ±è“®ç¸£</option><option>å°æ±ç¸£</option>
            <option>æ¾æ¹–ç¸£</option><option>é‡‘é–€ç¸£</option><option>é€£æ±Ÿç¸£</option>
          </select>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 3: Scratch games -->
        <div class="step" data-step="3">
          <label>æ‚¨ä»Šå¹´éƒ½è²·äº†å“ªäº›åˆ®åˆ®æ¨‚ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div class="game-grid" id="game-grid">
            <!-- $100 -->
            <label class="game-card" data-value="é¦¬å¹´è¡Œå¤§é‹ï¼ˆ$100ï¼‰">
              <input type="checkbox" name="types" value="é¦¬å¹´è¡Œå¤§é‹ï¼ˆ$100ï¼‰">
              <div class="game-icon">ğŸ´</div>
              <div>
                <div class="game-text-title">é¦¬å¹´è¡Œå¤§é‹ Â· $100</div>
              </div>
            </label>
            <label class="game-card" data-value="æ¨é‡‘å¹£ï¼ˆ$100ï¼‰">
              <input type="checkbox" name="types" value="æ¨é‡‘å¹£ï¼ˆ$100ï¼‰">
              <div class="game-icon">ğŸª™</div>
              <div>
                <div class="game-text-title">æ¨é‡‘å¹£ Â· $100</div>
              </div>
            </label>
            <label class="game-card" data-value="è²¡ç¥å ±åˆ°ï¼ˆ$100ï¼‰">
              <input type="checkbox" name="types" value="è²¡ç¥å ±åˆ°ï¼ˆ$100ï¼‰">
              <div class="game-icon">ğŸ§¨</div>
              <div>
                <div class="game-text-title">è²¡ç¥å ±åˆ° Â· $100</div>
              </div>
            </label>
            <label class="game-card" data-value="è²¡æºæ»¾æ»¾ï¼ˆ$100ï¼‰">
              <input type="checkbox" name="types" value="è²¡æºæ»¾æ»¾ï¼ˆ$100ï¼‰">
              <div class="game-icon">ğŸ“ˆ</div>
              <div>
                <div class="game-text-title">è²¡æºæ»¾æ»¾ Â· $100</div>
              </div>
            </label>

            <!-- $200 -->
            <label class="game-card" data-value="å¤§ä¸‰å…ƒï¼ˆ$200ï¼‰">
              <input type="checkbox" name="types" value="å¤§ä¸‰å…ƒï¼ˆ$200ï¼‰">
              <div class="game-icon">ğŸ€„</div>
              <div>
                <div class="game-text-title">å¤§ä¸‰å…ƒ Â· $200</div>
              </div>
            </label>
            <label class="game-card" data-value="é‡‘å¥½é‘½ï¼ˆ$200ï¼‰">
              <input type="checkbox" name="types" value="é‡‘å¥½é‘½ï¼ˆ$200ï¼‰">
              <div class="game-icon">ğŸ’</div>
              <div>
                <div class="game-text-title">é‡‘å¥½é‘½ Â· $200</div>
              </div>
            </label>
            <label class="game-card" data-value="çé‡‘æ¨‚ç¿»å€ï¼ˆ$200ï¼‰">
              <input type="checkbox" name="types" value="çé‡‘æ¨‚ç¿»å€ï¼ˆ$200ï¼‰">
              <div class="game-icon">ğŸ”</div>
              <div>
                <div class="game-text-title">çé‡‘æ¨‚ç¿»å€ Â· $200</div>
              </div>
            </label>
            <label class="game-card" data-value="çé‡‘å˜‰å¹´è¯ï¼ˆ$200ï¼‰">
              <input type="checkbox" name="types" value="çé‡‘å˜‰å¹´è¯ï¼ˆ$200ï¼‰">
              <div class="game-icon">ğŸª</div>
              <div>
                <div class="game-text-title">çé‡‘å˜‰å¹´è¯ Â· $200</div>
              </div>
            </label>

            <!-- $300 -->
            <label class="game-card" data-value="æµ·åº•å¤§å°‹å¯¶ï¼ˆ$300ï¼‰">
              <input type="checkbox" name="types" value="æµ·åº•å¤§å°‹å¯¶ï¼ˆ$300ï¼‰">
              <div class="game-icon">ğŸŸ</div>
              <div>
                <div class="game-text-title">æµ·åº•å¤§å°‹å¯¶ Â· $300</div>
              </div>
            </label>
            <label class="game-card" data-value="å¥½é‹é€£ç™¼ï¼ˆ$300ï¼‰">
              <input type="checkbox" name="types" value="å¥½é‹é€£ç™¼ï¼ˆ$300ï¼‰">
              <div class="game-icon">ğŸ‰</div>
              <div>
                <div class="game-text-title">å¥½é‹é€£ç™¼ Â· $300</div>
              </div>
            </label>

            <!-- $500 -->
            <label class="game-card" data-value="å“ˆå•¾å’ªï¼ˆ$500ï¼‰">
              <input type="checkbox" name="types" value="å“ˆå•¾å’ªï¼ˆ$500ï¼‰">
              <div class="game-icon">ğŸ˜º</div>
              <div>
                <div class="game-text-title">å“ˆå•¾å’ª Â· $500</div>
              </div>
            </label>
            <label class="game-card" data-value="äº”è·¯è²¡ç¥ï¼ˆ$500ï¼‰">
              <input type="checkbox" name="types" value="äº”è·¯è²¡ç¥ï¼ˆ$500ï¼‰">
              <div class="game-icon">ğŸ§§</div>
              <div>
                <div class="game-text-title">äº”è·¯è²¡ç¥ Â· $500</div>
              </div>
            </label>
            <label class="game-card" data-value="é‡‘é¦¬çï¼ˆ$500ï¼‰">
              <input type="checkbox" name="types" value="é‡‘é¦¬çï¼ˆ$500ï¼‰">
              <div class="game-icon">ğŸ†</div>
              <div>
                <div class="game-text-title">é‡‘é¦¬ç Â· $500</div>
              </div>
            </label>

            <!-- $1000 -->
            <label class="game-card" data-value="1200è¬å¤§å‰åˆ©ï¼ˆ$1,000ï¼‰">
              <input type="checkbox" name="types" value="1200è¬å¤§å‰åˆ©ï¼ˆ$1,000ï¼‰">
              <div class="game-icon">ğŸ’°</div>
              <div>
                <div class="game-text-title">1200è¬å¤§å‰åˆ© Â· $1,000</div>
              </div>
            </label>

            <!-- $2000 -->
            <label class="game-card" data-value="2000è¬è¶…ç´šç´…åŒ…ï¼ˆ$2,000ï¼‰">
              <input type="checkbox" name="types" value="2000è¬è¶…ç´šç´…åŒ…ï¼ˆ$2,000ï¼‰">
              <div class="game-icon">ğŸ§§</div>
              <div>
                <div class="game-text-title">2000è¬è¶…ç´šç´…åŒ… Â· $2,000</div>
              </div>
            </label>
          </div>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 4: Spent -->
        <div class="step" data-step="4">
          <label for="spent">æ‚¨ç¸½å…±è²·äº†å¤šå°‘éŒ¢çš„åˆ®åˆ®æ¨‚ï¼Ÿï¼ˆå…ƒï¼‰</label>
          <input id="spent" name="spent" type="text" inputmode="decimal" pattern="[0-9]*" required>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 5: Won -->
        <div class="step" data-step="5">
          <label for="won-amount">æœ€å¾Œæ‚¨è³ºè³ å¤šå°‘éŒ¢ï¼Ÿ</label>
          <div class="money-row">
            <select id="won-sign" name="won-sign">
              <option value="+">+ è³º</option>
              <option value="-">- è³ </option>
            </select>
            <input id="won-amount" name="won-amount" type="text" inputmode="decimal" pattern="[0-9]*" placeholder="è«‹è¼¸å…¥é‡‘é¡ï¼Œä¾‹å¦‚ 5000 æˆ– 800" required>
          </div>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="submit">é€å‡ºæˆ°å ±</button>
          </div>
        </div>
      </form>
      <div class="footer-note">âš ï¸ å°ç£æ³•è¦ï¼šæœªæ»¿ 18 æ­²ä¸å¾—è³¼è²·æˆ–å…Œé ˜å½©åˆ¸ï¼ˆåŒ…æ‹¬åˆ®åˆ®æ¨‚ï¼‰ã€‚æœ¬å•å·åƒ…ä¾›æ»¿ 18 æ­²ä»¥ä¸Šæ°‘çœ¾åˆ†äº«ç¶“é©—ã€‚</div>
    </section>

    <section class="card" id="result-card" style="display:none;"></section>
  </div>
</div>

<!-- è¼‰å…¥ä¸­è¦†è“‹å±¤ -->
<div id="loading-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:999; align-items:center; justify-content:center;">
  <div style="background:#111827; color:#e5e7eb; padding:14px 18px; border-radius:999px; display:flex; align-items:center; gap:10px; box-shadow:0 10px 25px rgba(0,0,0,.6);">
    <div class="spinner" style="width:18px;height:18px;border-radius:999px;border:2px solid rgba(249,250,251,.3);border-top-color:#fbbf24;animation:spin 0.7s linear infinite;"></div>
    <div style="font-size:14px;">æ­£åœ¨çµç®—æˆ°ç¸¾â€¦</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbwlG_o5n-TsPoS7_l89ngOjEVBa5YkwoCgz2vwwDhNv45kxAy2f_URXvLurOSRpSIss7A/exec";

  const form = document.getElementById("survey-form");
  const resultCard = document.getElementById("result-card");
  const progressBar = document.getElementById("progress-bar");
  const steps = Array.from(document.querySelectorAll(".step"));
  const formCard = document.getElementById("form-card");
  const gameGrid = document.getElementById("game-grid");
  const loadingOverlay = document.getElementById("loading-overlay");

  const TYPE_RULES = [
    // matchKeyï¼šè·Ÿè‡ªå·±æœ€åˆå¾—ä¾†çš„é¡å‹ï¼›clashKeyï¼šæœ€å®¹æ˜“åµæ¶çš„é¡å‹
    { key: 'A', name: 'é«˜å€æ•¸æ¢­å“ˆè²¡ç¥',        matchKey: 'G', clashKey: 'H', image: 'img/Type-A.PNG' },
    { key: 'B', name: 'ç©©å¥å›æœ¬å¿ƒéˆè‚¡æ±',      matchKey: 'H', clashKey: 'D', image: 'img/Type-B.PNG' },
    { key: 'C', name: 'å°è³ ç•¶è²·æ°£æ°›å‹',        matchKey: 'G', clashKey: 'A', image: 'img/Type-C.PNG' },
    { key: 'D', name: 'å°å½©å¹´åº¦ VIP è´ŠåŠ©å•†',  matchKey: 'C', clashKey: 'H', image: 'img/Type-D.PNG' },
    { key: 'E', name: 'ä½›ç³»é›¶æå¹³æ‰‹ç‹',        matchKey: 'F', clashKey: 'A', image: 'img/Type-E.PNG' },
    { key: 'F', name: 'é‚Šåˆ®é‚Šç•¶è³‡æ–™ç§‘å­¸å®¶',    matchKey: 'B', clashKey: 'D', image: 'img/Type-F.PNG' },
    { key: 'G', name: 'å…¨å®¶æ­¡æ¨‚æªåœ˜é•·',        matchKey: 'C', clashKey: 'D', image: 'img/Type-G.PNG' },
    { key: 'H', name: 'å°å¿ƒç¿¼ç¿¼ç†è²¡é¦¬',        matchKey: 'B', clashKey: 'D', image: 'img/Type-H.PNG' }
  ];

  function showStep(n) {
    steps.forEach((step, idx) => {
      step.classList.toggle("active", idx === n - 1);
    });
    const percent = (n - 1) / steps.length * 100;
    progressBar.style.width = `${percent}%`;
  }

  if (gameGrid) {
    gameGrid.addEventListener("click", (e) => {
      const card = e.target.closest(".game-card");
      if (!card) return;
      const checkbox = card.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      card.classList.toggle("selected", checkbox.checked);
    });
  }

  steps.forEach((step, idx) => {
    const nextBtn = step.querySelector("[data-next]");
    const prevBtn = step.querySelector("[data-prev]");

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        const inputs = step.querySelectorAll("select, input[required]");
        for (const input of inputs) {
          if (!input.value) {
            input.reportValidity();
            return;
          }
        }
        if (step.dataset.step === "3") {
          const checked = step.querySelectorAll('input[name="types"]:checked');
          if (!checked.length) {
            alert("è‡³å°‘å‹¾é¸ä¸€ç¨®åˆ®åˆ®æ¨‚ï¼Œæ‰å¥½å¹«æ‚¨ç®—æˆ°ç¸¾ï¼");
            return;
          }
        }
        showStep(idx + 2);
      });
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        showStep(Math.max(1, idx));
      });
    }
  });

  async function downloadResultImage() {
    const card = resultCard;
    if (!card) return;
    const canvas = await html2canvas(card, {backgroundColor: "#fff"});
    const link = document.createElement("a");
    link.download = "scratch-lottery-result.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  function playAgain() {
    window.location.href = window.location.pathname + window.location.search;
  }

  function parseMoney(value) {
    if (!value) return 0;
    const cleaned = value.toString().replace(/[^0-9]/g, "");
    const num = Number(cleaned);
    return isNaN(num) ? 0 : num;
  }

  function classifyType(spent, net, typesStr) {
    const roi = spent > 0 ? (net / spent) * 100 : 0;
    const hasHighRoller = /1200è¬å¤§å‰åˆ©|2000è¬è¶…ç´šç´…åŒ…/.test(typesStr || "");

    if (net > 0 && roi >= 50) return TYPE_RULES[0];            // é«˜å€æ•¸æ¢­å“ˆè²¡ç¥
    if (roi >= 0 && roi < 50) return TYPE_RULES[1];            // ç©©å¥å›æœ¬å¿ƒéˆè‚¡æ±
    if (roi < 0 && roi > -30) return TYPE_RULES[2];            // å°è³ ç•¶è²·æ°£æ°›å‹
    if (roi <= -60 || hasHighRoller) return TYPE_RULES[3];     // å°å½©å¹´åº¦ VIP è´ŠåŠ©å•†
    if (net === 0) return TYPE_RULES[4];                        // ä½›ç³»é›¶æå¹³æ‰‹ç‹
    if (spent === 0 && net === 0) return TYPE_RULES[5];         // é‚Šåˆ®é‚Šç•¶è³‡æ–™ç§‘å­¸å®¶
    if (spent > 0 && /é¦¬å¹´è¡Œå¤§é‹|è²¡ç¥å ±åˆ°|è²¡æºæ»¾æ»¾/.test(typesStr || "")) return TYPE_RULES[6]; // å…¨å®¶æ­¡æ¨‚æªåœ˜é•·
    return TYPE_RULES[7];                                       // å°å¿ƒç¿¼ç¿¼ç†è²¡é¦¬
  }

  async function getPercentileFromSheet(roi) {
    try {
      const res = await fetch(`${SHEET_ENDPOINT}?action=percentile&roi=${encodeURIComponent(roi)}`);
      if (!res.ok) return null;
      const data = await res.json();
      if (typeof data.percentile === 'number' && !isNaN(data.percentile)) {
        return data.percentile;
      }
      return null;
    } catch (e) {
      console.warn('percentile fetch failed', e);
      return null;
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (loadingOverlay) loadingOverlay.style.display = "flex";

    const formData = new FormData(form);
    const age = formData.get("age");
    const city = formData.get("city");
    const types = formData.getAll("types").join(", ");
    const spent = parseMoney(formData.get("spent"));

    const wonSign = formData.get("won-sign") === "-" ? -1 : 1;
    const wonAmount = parseMoney(formData.get("won-amount"));
    const won = wonSign * wonAmount;

    const net = won - spent;
    const roi = spent > 0 ? (net / spent) * 100 : 0;

    let percentile = await getPercentileFromSheet(roi);
    if (percentile === null || isNaN(percentile)) {
      if (spent === 0) {
        percentile = 50;
      } else if (roi >= 50) {
        percentile = 95;
      } else if (roi >= 0) {
        percentile = 75;
      } else if (roi > -50) {
        percentile = 45;
      } else {
        percentile = 25;
      }
    }
    // å®‰å…¨ç¯„åœï¼šé¿å…å‡ºç¾ 0% æˆ– 100%
    if (percentile < 1) percentile = 1;
    if (percentile > 99) percentile = 99;

    const typeInfo = classifyType(spent, net, types);
    const clashType = TYPE_RULES.find(t => t.key === typeInfo.clashKey) || TYPE_RULES[0];
    const matchType = TYPE_RULES.find(t => t.key === (typeInfo.matchKey || typeInfo.key)) || typeInfo;

    const main = `é€™æ¬¡æ‚¨ç¸½å…± ${spent.toLocaleString()} å…ƒåˆ®åˆ®æ¨‚ï¼Œæœ€å¾Œ${net >= 0 ? "å°è³º" : "å°è³ "} ${Math.abs(net).toLocaleString()} å…ƒï¼ˆæŠ•å ±ç‡ç´„ ${roi.toFixed(1)}%ï¼‰`;
    const compare = `åœ¨ç›®å‰ç´¯ç©çš„åƒèˆ‡è€…ä¸­ï¼Œæ‚¨å¤§ç´„è½åœ¨å‰ ${percentile}% çš„å€é–“ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ã€‚`;

    let banner;
    if (net > 0) {
      banner = "ä»Šå¹´è²¡ç¥æœ‰çœ·é¡§æ‚¨ï¼Œä½†é‚„æ˜¯è¨˜å¾—ï¼šä¸è¦æ‹¿ç”Ÿæ´»è²»è·Ÿåˆ®åˆ®æ¨‚ç¡¬ç¢°ç¢°ã€‚";
    } else if (net === 0) {
      banner = "å¹³æ‰‹éå¹´ï¼Œç­‰æ–¼è²·äº†ä¸€æ•´å¥—å…¨å®¶å¨›æ¨‚ï¼Œé‚„è¡Œã€‚";
    } else if (roi < -50) {
      banner = "æ‚¨æ˜¯å°å½© Q4 çš„é‡è¦è²¢ç»è€…ï¼Œå»ºè­°æ˜å¹´æ”¹æˆæŠŠé€™ç­†éŒ¢ä¸Ÿé€²æŒ‡æ•¸åŒ–æŠ•è³‡ã€‚";
    } else {
      banner = "å°è³ é‚„åœ¨å®‰å…¨ç¯„åœå…§ï¼Œæ˜å¹´å¯ä»¥å…ˆè¨­å®šå¥½é ç®—ï¼Œä¸Šé™åˆ°äº†å°±æ”¶æ‰‹ã€‚";
    }

    if (formCard) formCard.style.display = "none";
    resultCard.style.display = "block";
    resultCard.innerHTML = `
      <div class="badge-title">é¦¬å¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾</div>
      <div class="result-main">æ‚¨çš„ç¨±è™Ÿæ˜¯ï¼š<span class="result-tag">${typeInfo.name}</span></div>
      <div class="confetti-row">ğŸŠ ğŸ‰ ğŸ§§</div>
      <div class="result-main">${main}</div>
      <div class="result-detail">${compare}</div>
      <div class="result-image-wrap">
        <img src="${typeInfo.image}" alt="${typeInfo.name}" class="result-type-img">
      </div>
      <div class="type-row">
        <div class="type-col">
          <div class="type-section-title">åˆé©çš„é¡å‹</div>
          <div class="result-detail"><span class="type-label-big">${matchType.name}</span></div>
        </div>
        <div class="type-col">
          <div class="type-section-title">å®¹æ˜“åµæ¶çš„é¡å‹</div>
          <div class="result-detail"><span class="type-label-big">${clashType.name}</span></div>
        </div>
      </div>
      <div class="result-banner">${banner}</div>
      <div class="result-actions">
        <button type="button" onclick="downloadResultImage()">ä¸‹è¼‰æˆæœ</button>
        <button type="button" onclick="playAgain()">å†ç©ä¸€æ¬¡</button>
      </div>
    `;

    const payload = {
      timestamp: new Date().toISOString(),
      age,
      city,
      types,
      spent,
      won,
      net,
      roi,
      nickname: typeInfo.name,
    };

    try {
      await fetch(SHEET_ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      console.warn("å¯«å…¥ Google Sheets å¤±æ•—ï¼ˆå…ˆä¸å½±éŸ¿é«”é©—ï¼‰", err);
    } finally {
      if (loadingOverlay) loadingOverlay.style.display = "none";
    }
  });

  showStep(1);
</script>
</body>
</html>
