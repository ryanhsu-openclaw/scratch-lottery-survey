<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>éå¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾èª¿æŸ¥ Â· é¦¬å¹´è²¡é‹å¤§é»å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-top: #fee2e2;
      --bg-mid: #f97316;
      --bg-bottom: #7f1d1d;
      --panel: #fff7ed;
      --border: #fed7aa;
      --accent: #f97316;
      --accent-strong: #ea580c;
      --accent-soft: rgba(248, 113, 113, 0.15);
      --text: #3f1d1d;
      --muted: #9f1239;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, var(--bg-top) 0, var(--bg-mid) 45%, var(--bg-bottom) 90%);
      color: var(--text);
      font-size: 17px;
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    header {
      text-align: center;
      margin-bottom: 16px;
      color: #fef2f2;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 30px;
    }
    .subtitle {
      font-size: 16px;
      opacity: 0.95;
    }

    .lantern-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 10px 0 12px;
      color: #fef2f2;
      font-size: 14px;
    }
    .lantern {
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(254, 226, 226, 0.9);
      background: rgba(248, 250, 252, 0.15);
    }

    .warning {
      margin: 0 auto 16px;
      max-width: 680px;
      font-size: 14px;
      color: #b91c1c;
      background: #fee2e2;
      border: 1px solid #fecaca;
      padding: 8px 12px;
      border-radius: 10px;
    }

    .layout {
      display: grid;
      gap: 18px;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, .8fr);
      align-items: flex-start;
    }
    @media (max-width: 840px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 18px 20px 20px;
      box-shadow: 0 16px 34px rgba(127, 29, 29, 0.35);
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 22px;
    }

    .progress-shell { margin-bottom: 14px; }
    .progress-track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #fee2e2;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, #fb923c, #facc15);
      transition: width 0.35s ease-out;
    }

    label {
      display: block;
      margin: 14px 0 6px;
      font-size: 17px;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 12px 13px;
      border-radius: 12px;
      border: 1px solid #fed7aa;
      background: #fff7f7;
      color: var(--text);
      font-size: 16px;
      transition: box-shadow 0.2s ease, transform 0.08s ease;
    }
    select:focus, input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.7);
      transform: translateY(-1px);
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px 14px;
      margin-top: 8px;
    }
    .game-card {
      position: relative;
      padding: 10px 10px 9px;
      border-radius: 14px;
      border: 1px solid #fed7aa;
      background: #fff7f5;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
    }
    .game-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(248, 113, 113, 0.35);
    }
    .game-card.selected {
      border-color: #f97316;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.6);
      background: #fff1e6;
    }
    .game-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: #fee2e2;
    }
    .game-text-title {
      font-size: 15px;
      font-weight: 600;
    }
    .game-text-meta {
      font-size: 13px;
      color: var(--muted);
    }
    .game-card input[type="checkbox"] { display: none; }

    .hint {
      font-size: 14px;
      color: var(--muted);
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    .nav-buttons button { flex: 1; }
    .nav-buttons .back {
      background: #fee2e2;
      color: var(--muted);
      box-shadow: none;
    }

    button {
      margin-top: 20px;
      width: 100%;
      padding: 13px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, #f97316, #facc15);
      color: #450a0a;
      font-weight: 800;
      font-size: 17px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(248, 250, 252, 0.25);
      transition: transform 0.09s ease, box-shadow 0.09s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(248, 250, 252, 0.35);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
    }
    button:disabled {
      opacity: .6;
      cursor: wait;
    }

    .result-title {
      font-size: 22px;
      margin-bottom: 8px;
      font-weight: 800;
    }
    .result-main {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .result-detail {
      font-size: 15px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .result-banner {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--accent-soft);
      border: 1px solid rgba(248,113,113,.5);
      font-size: 16px;
    }

    .result-actions {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .result-actions button {
      flex: 1;
      min-width: 140px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }

    .step { display: none; }
    .step.active { display: block; animation: fadeIn 0.25s ease-out; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸ§§ğŸ´ éå¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾èª¿æŸ¥</h1>
    <div class="subtitle">é¦¬å¹´è²¡é‹å¤§é»åï¼šçœ‹çœ‹æ‚¨æ˜¯è²¡ç¥ã€è´ŠåŠ©å•†ï¼Œé‚„æ˜¯å‚³èªªä¸­çš„ã€Œå›æœ¬ä»”ã€ï¼Ÿ</div>
    <div class="lantern-row">
      <div class="lantern">ç¦</div>
      <div class="lantern">é¦¬å¹´è¡Œå¤§é‹</div>
      <div class="lantern">åˆ®å‡ºå¥½æ‰‹æ°£</div>
      <div class="lantern">æ­å–œç™¼è²¡</div>
    </div>
  </header>

  <div class="warning">âš ï¸ å°ç£æ³•è¦ï¼šæœªæ»¿ 18 æ­²ä¸å¾—è³¼è²·æˆ–å…Œé ˜å½©åˆ¸ï¼ˆåŒ…æ‹¬åˆ®åˆ®æ¨‚ï¼‰ã€‚æœ¬å•å·åƒ…ä¾›æ»¿ 18 æ­²ä»¥ä¸Šæ°‘çœ¾åˆ†äº«ç¶“é©—ã€‚</div>

  <div class="layout">
    <section class="card" id="form-card">
      <h2>å¡«å¯«æ‚¨çš„éå¹´åˆ®åˆ®æ¨‚æˆ°å ±</h2>
      <div class="progress-shell">
        <div class="progress-track"><div class="progress-bar" id="progress-bar"></div></div>
      </div>
      <form id="survey-form">
        <!-- Step 1: Age -->
        <div class="step active" data-step="1">
          <label for="age">æ‚¨å¹¾æ­²ï¼Ÿ</label>
          <select id="age" name="age" required>
            <option value="" disabled selected>è«‹é¸æ“‡å¹´é½¡å€é–“ï¼ˆåƒ…é™ 18 æ­²ä»¥ä¸Šï¼‰</option>
            <option>18â€“24 æ­²</option>
            <option>25â€“34 æ­²</option>
            <option>35â€“44 æ­²</option>
            <option>45â€“54 æ­²</option>
            <option>55â€“64 æ­²</option>
            <option>65 æ­²ä»¥ä¸Š</option>
          </select>
          <div class="hint">æé†’ï¼šæœªæ»¿ 18 æ­²ä¸å¾—è³¼è²·å½©åˆ¸ã€‚æœ¬å•å·åƒ…ä¾›æˆå¹´å¾Œçš„å°è³­å¿ƒå¾—åˆ†äº«ã€‚</div>
          <div class="nav-buttons">
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 2: City -->
        <div class="step" data-step="2">
          <label for="city">æ‚¨åœ¨å“ªè£¡éå¹´ï¼Ÿ</label>
          <select id="city" name="city" required>
            <option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>
            <option>å°åŒ—å¸‚</option><option>æ–°åŒ—å¸‚</option><option>åŸºéš†å¸‚</option>
            <option>æ¡ƒåœ’å¸‚</option><option>æ–°ç«¹å¸‚</option><option>æ–°ç«¹ç¸£</option>
            <option>è‹—æ —ç¸£</option><option>å°ä¸­å¸‚</option><option>å½°åŒ–ç¸£</option>
            <option>å—æŠ•ç¸£</option><option>é›²æ—ç¸£</option><option>å˜‰ç¾©å¸‚</option><option>å˜‰ç¾©ç¸£</option>
            <option>å°å—å¸‚</option><option>é«˜é›„å¸‚</option><option>å±æ±ç¸£</option>
            <option>å®œè˜­ç¸£</option><option>èŠ±è“®ç¸£</option><option>å°æ±ç¸£</option>
            <option>æ¾æ¹–ç¸£</option><option>é‡‘é–€ç¸£</option><option>é€£æ±Ÿç¸£</option>
          </select>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 3: Scratch games -->
        <div class="step" data-step="3">
          <label>æ‚¨ä»Šå¹´éƒ½è²·äº†å“ªäº›åˆ®åˆ®æ¨‚ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div class="game-grid" id="game-grid">
            <!-- é€™è£¡çš„å¡ç‰‡å¯ä»¥æŒ‰ç…§æ‚¨å¾å°å½©å®˜ç¶²æ•´ç†çš„æ¸…å–®å†æ›¿æ›ï¼Œç›®å‰å…ˆæ”¾ä»£è¡¨æ€§æ¬¾å¼ -->
            <label class="game-card" data-value="é‡‘ç‰Œ777ï¼ˆ500 å…ƒï¼‰">
              <input type="checkbox" name="types" value="é‡‘ç‰Œ777ï¼ˆ500 å…ƒï¼‰">
              <div class="game-icon">7ï¸âƒ£</div>
              <div>
                <div class="game-text-title">é‡‘ç‰Œ777</div>
                <div class="game-text-meta">500 å…ƒ Â· ç¶“å…¸ 777 ä¸»é¡Œ</div>
              </div>
            </label>
            <label class="game-card" data-value="ä¸€è·¯ç™¼ï¼ˆ200 å…ƒï¼‰">
              <input type="checkbox" name="types" value="ä¸€è·¯ç™¼ï¼ˆ200 å…ƒï¼‰">
              <div class="game-icon">8ï¸âƒ£</div>
              <div>
                <div class="game-text-title">ä¸€è·¯ç™¼</div>
                <div class="game-text-meta">200 å…ƒ Â· å–œæ°£ä¸€è·¯ç™¼ç™¼ç™¼</div>
              </div>
            </label>
            <label class="game-card" data-value="åŠ å€æ—ºï¼ˆ200 å…ƒï¼‰">
              <input type="checkbox" name="types" value="åŠ å€æ—ºï¼ˆ200 å…ƒï¼‰">
              <div class="game-icon">ğŸ“ˆ</div>
              <div>
                <div class="game-text-title">åŠ å€æ—º</div>
                <div class="game-text-meta">200 å…ƒ Â· åŠ å€è´ã€åŠ å€æ—º</div>
              </div>
            </label>
            <label class="game-card" data-value="ç„¡æ•µå¨åŠ›ï¼ˆ300 å…ƒï¼‰">
              <input type="checkbox" name="types" value="ç„¡æ•µå¨åŠ›ï¼ˆ300 å…ƒï¼‰">
              <div class="game-icon">ğŸ’¥</div>
              <div>
                <div class="game-text-title">ç„¡æ•µå¨åŠ›</div>
                <div class="game-text-meta">300 å…ƒ Â· å¨åŠ›æ»¿æ»¿çš„ç›¤é¢</div>
              </div>
            </label>
            <label class="game-card" data-value="é‡‘ç”œèœœï¼ˆ100 å…ƒï¼‰">
              <input type="checkbox" name="types" value="é‡‘ç”œèœœï¼ˆ100 å…ƒï¼‰">
              <div class="game-icon">ğŸ»</div>
              <div>
                <div class="game-text-title">é‡‘ç”œèœœ</div>
                <div class="game-text-meta">100 å…ƒ Â· ç†Šç†Šèˆ‡é‡‘å¹£</div>
              </div>
            </label>
            <label class="game-card" data-value="åˆ®åˆ®é‡‘æ¨‚é€ï¼ˆ200 å…ƒï¼‰">
              <input type="checkbox" name="types" value="åˆ®åˆ®é‡‘æ¨‚é€ï¼ˆ200 å…ƒï¼‰">
              <div class="game-icon">ğŸ’²</div>
              <div>
                <div class="game-text-title">åˆ®åˆ®é‡‘æ¨‚é€</div>
                <div class="game-text-meta">200 å…ƒ Â· æ¨‚é€æ„Ÿæ»¿æ»¿</div>
              </div>
            </label>
            <label class="game-card" data-value="æ˜Ÿéš›å°‹å¯¶ï¼ˆ200 å…ƒï¼‰">
              <input type="checkbox" name="types" value="æ˜Ÿéš›å°‹å¯¶ï¼ˆ200 å…ƒï¼‰">
              <div class="game-icon">ğŸª</div>
              <div>
                <div class="game-text-title">æ˜Ÿéš›å°‹å¯¶</div>
                <div class="game-text-meta">200 å…ƒ Â· å¤ªç©ºå°‹å¯¶ä¸»é¡Œ</div>
              </div>
            </label>
            <label class="game-card" data-value="æ­¡æ¨‚é›™æ˜Ÿï¼ˆ200 å…ƒï¼‰">
              <input type="checkbox" name="types" value="æ­¡æ¨‚é›™æ˜Ÿï¼ˆ200 å…ƒï¼‰">
              <div class="game-icon">â­</div>
              <div>
                <div class="game-text-title">æ­¡æ¨‚é›™æ˜Ÿ</div>
                <div class="game-text-meta">200 å…ƒ Â· æ˜Ÿæ˜Ÿåœ–æ¡ˆè¶…ç¹½ç´›</div>
              </div>
            </label>
            <label class="game-card" data-value="å…¶ä»–">
              <input type="checkbox" name="types" value="å…¶ä»–">
              <div class="game-icon">âœ¨</div>
              <div>
                <div class="game-text-title">å…¶ä»–æ¬¾å¼</div>
                <div class="game-text-meta">ä¸Šé¢æ²’åˆ—åˆ°çš„éƒ½ç®—åœ¨é€™è£¡</div>
              </div>
            </label>
          </div>
          <div class="hint">å“åå¯ä»¥å…ˆå‹¾å¤§è‡´ç³»åˆ—ï¼Œä¹‹å¾Œæœƒå†å°é½Šå°å½©å®˜æ–¹å®Œæ•´æ¸…å–®ã€‚</div>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 4: Spent -->
        <div class="step" data-step="4">
          <label for="spent">æ‚¨ç¸½å…±è²·äº†å¤šå°‘éŒ¢çš„åˆ®åˆ®æ¨‚ï¼Ÿï¼ˆå…ƒï¼‰</label>
          <input id="spent" name="spent" type="text" inputmode="decimal" pattern="[0-9]*" required>
          <div class="hint">å¯ä»¥å¡« 0ï¼Œä»£è¡¨åªæ˜¯å¹«å®¶äººåˆ®ã€è‡ªå·±æ²’èŠ±éŒ¢ã€‚</div>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="button" data-next>ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <!-- Step 5: Won -->
        <div class="step" data-step="5">
          <label for="won">æœ€å¾Œæ‚¨è´äº†å¤šå°‘éŒ¢ï¼Ÿï¼ˆå¯å¡« 0 æˆ–è² å€¼ï¼Œè² ä»£è¡¨è³ éŒ¢ï¼‰</label>
          <input id="won" name="won" type="text" inputmode="decimal" placeholder="ä¾‹å¦‚ 5000 æˆ– -800" required>
          <div class="hint">ä¾‹å¦‚ï¼šè´ 5000 å°±å¡« 5000ï¼›æ•´é«”å°è³  800 å°±å¡« -800ï¼›å®Œå…¨æ²’è¼¸æ²’è´å°±å¡« 0ã€‚</div>
          <div class="nav-buttons">
            <button type="button" class="back" data-prev>ä¸Šä¸€é¡Œ</button>
            <button type="submit">é€å‡ºæˆ°å ±</button>
          </div>
        </div>
      </form>
      <div class="footer-note">è³‡æ–™åƒ…ç”¨æ–¼çµ±è¨ˆèˆ‡ç”¢ç”Ÿç¾¤é«”æˆ°ç¸¾ï¼Œæ²’æœ‰æ”¶é›†è¯çµ¡æ–¹å¼ã€‚</div>
    </section>

    <section class="card" id="result-card" style="display:none;"></section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const SHEET_ENDPOINT = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

  const form = document.getElementById("survey-form");
  const resultCard = document.getElementById("result-card");
  const progressBar = document.getElementById("progress-bar");
  const steps = Array.from(document.querySelectorAll(".step"));
  const formCard = document.getElementById("form-card");
  const gameGrid = document.getElementById("game-grid");

  const TITLES = [
    "é¦¬å¹´é«˜å€è²¡ç¥",
    "ç©©å¥å›æœ¬ä»”",
    "ç†±è¡€è´ŠåŠ©å•†",
    "å†·éœç†è²¡é¦¬",
    "åˆ®åˆ°æ‰‹é…¸ä½†é‚„ç¬‘å¾—å‡ºä¾†å‹"
  ];

  function showStep(n) {
    steps.forEach((step, idx) => {
      step.classList.toggle("active", idx === n - 1);
    });
    const percent = (n - 1) / steps.length * 100;
    progressBar.style.width = `${percent}%`;
  }

  // åˆ®åˆ®æ¨‚å¡ç‰‡é»æ“Šæ•ˆæœ
  if (gameGrid) {
    gameGrid.addEventListener("click", (e) => {
      const card = e.target.closest(".game-card");
      if (!card) return;
      const checkbox = card.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      card.classList.toggle("selected", checkbox.checked);
    });
  }

  // æŒ‰ã€Œä¸‹ä¸€é¡Œã€åˆ‡æ›æ­¥é©Ÿèˆ‡ä¸Šä¸€é¡Œè¿”å›
  steps.forEach((step, idx) => {
    const nextBtn = step.querySelector("[data-next]");
    const prevBtn = step.querySelector("[data-prev]");

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        const inputs = step.querySelectorAll("select, input[required]");
        for (const input of inputs) {
          if (!input.value) {
            input.reportValidity();
            return;
          }
        }
        if (step.dataset.step === "3") {
          const checked = step.querySelectorAll('input[name="types"]:checked');
          if (!checked.length) {
            alert("è‡³å°‘å‹¾é¸ä¸€ç¨®åˆ®åˆ®æ¨‚ï¼Œæ‰å¥½å¹«æ‚¨ç®—æˆ°ç¸¾ï¼");
            return;
          }
        }
        showStep(idx + 2);
      });
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        showStep(Math.max(1, idx));
      });
    }
  });

  async function downloadResultImage() {
    const card = resultCard;
    if (!card) return;
    const canvas = await html2canvas(card, {backgroundColor: "#fff"});
    const link = document.createElement("a");
    link.download = "scratch-lottery-result.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  async function shareResult(text) {
    const shareUrl = window.location.href.split("?")[0];
    const finalText = text || "æˆ‘å‰›åšäº†éå¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾èª¿æŸ¥ï¼Œä¸€èµ·ä¾†çœ‹çœ‹ä½ æ˜¯è²¡ç¥é‚„æ˜¯è´ŠåŠ©å•†ï¼";
    if (navigator.share) {
      try {
        await navigator.share({ title: "éå¹´åˆ®åˆ®æ¨‚æˆ°ç¸¾èª¿æŸ¥", text: finalText, url: shareUrl });
      } catch (e) {
        console.warn("ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«", e);
      }
    } else {
      const shareMessage = `${finalText}\n${shareUrl}`;
      navigator.clipboard?.writeText(shareMessage).then(() => {
        alert("å·²è¤‡è£½çµæœé€£çµï¼Œå¿«è²¼åˆ°ç¾¤çµ„è·Ÿæœ‹å‹ç‚«è€€æˆ–å–æš–ï¼");
      }).catch(() => {
        alert("ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•è¤‡è£½ï¼Œæ‚¨å¯ä»¥æ‰‹å‹•åˆ†äº«ç¶²å€ï¼š" + shareUrl);
      });
    }
  }

  function parseMoney(value, allowNegative = false) {
    if (!value) return 0;
    const cleaned = value.toString().replace(/[^0-9-]/g, "");
    let num = Number(cleaned);
    if (!allowNegative && num < 0) num = 0;
    return isNaN(num) ? 0 : num;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const age = formData.get("age");
    const city = formData.get("city");
    const types = formData.getAll("types").join(", ");
    const spent = parseMoney(formData.get("spent"), false);
    const won = parseMoney(formData.get("won"), true);

    const net = won - spent;
    const roi = spent > 0 ? (net / spent) * 100 : 0;

    let percentile;
    if (spent === 0) {
      percentile = 50;
    } else if (roi >= 50) {
      percentile = 95;
    } else if (roi >= 0) {
      percentile = 75;
    } else if (roi > -50) {
      percentile = 45;
    } else {
      percentile = 25;
    }

    const randomTitle = TITLES[Math.floor(Math.random() * TITLES.length)];

    const title = net >= 0 ? "æ­å–œï¼Œæ‚¨æ˜¯é€™æ³¢çš„è²¡ç¥ä¹‹ä¸€ï¼" : "è¾›è‹¦äº†ï¼Œæ‚¨æ­£å¼æˆç‚ºå°å½©ç„¡åè‚¡æ±ã€‚";
    const main = `é€™æ¬¡æ‚¨ç¸½å…± ${spent.toLocaleString()} å…ƒåˆ®åˆ®æ¨‚ï¼Œæœ€å¾Œ${net >= 0 ? "å°è³º" : "å°è³ "} ${Math.abs(net).toLocaleString()} å…ƒï¼ˆæŠ•å ±ç‡ç´„ ${roi.toFixed(1)}%ï¼‰`;
    const compare = `ä¾ç…§ç›®å‰çš„æ¨¡æ“¬åˆ†ä½ˆï¼Œæ‚¨å¤§ç´„è´éç´„ ${percentile}% çš„åƒèˆ‡è€…ã€‚`;

    let banner;
    if (net > 0) {
      banner = "ä»Šå¹´è²¡ç¥æœ‰çœ·é¡§æ‚¨ï¼Œä½†é‚„æ˜¯è¨˜å¾—ï¼šä¸è¦æ‹¿ç”Ÿæ´»è²»è·Ÿåˆ®åˆ®æ¨‚ç¡¬ç¢°ç¡¬ã€‚";
    } else if (net === 0) {
      banner = "å¹³æ‰‹éå¹´ï¼Œç­‰æ–¼è²·äº†ä¸€æ•´å¥—å…¨å®¶å¨›æ¨‚ï¼Œé‚„è¡Œã€‚";
    } else if (roi < -50) {
      banner = "æ‚¨æ˜¯å°å½© Q4 çš„é‡è¦è²¢ç»è€…ï¼Œå»ºè­°æ˜å¹´æ”¹æˆæŠŠé€™ç­†éŒ¢ä¸Ÿé€²æŒ‡æ•¸åŒ–æŠ•è³‡ã€‚";
    } else {
      banner = "å°è³ é‚„åœ¨å®‰å…¨ç¯„åœå…§ï¼Œæ˜å¹´å¯ä»¥å…ˆè¨­å®šå¥½é ç®—ï¼Œä¸Šé™åˆ°äº†å°±æ”¶æ‰‹ã€‚";
    }

    const shareText = `æˆ‘çš„é¦¬å¹´åˆ®åˆ®æ¨‚ç¨±è™Ÿæ˜¯ã€Œ${randomTitle}ã€ï¼Œ${main}ï¼Œ${compare}`;

    // å•å·çµæœç•«é¢ï¼šåªä¿ç•™çµæœï¼Œä¸å†é¡¯ç¤ºé¡Œç›®ï¼ˆå³å´çµæœå¡ç‰‡ä»ä¿ç•™ï¼‰
    if (formCard) formCard.style.display = "none";
    resultCard.style.display = "block";
    resultCard.innerHTML = `
      <div class="result-title">${title}</div>
      <div class="result-main">æœ¬æ¬¡ç³»çµ±é ’çµ¦æ‚¨çš„é¦¬å¹´ç¨±è™Ÿæ˜¯ï¼š<strong>${randomTitle}</strong></div>
      <div class="result-main">${main}</div>
      <div class="result-detail">èƒŒæ™¯è³‡æ–™ï¼š${age}ã€åœ¨ ${city} éå¹´${types ? `ï¼Œæœ‰è²·ï¼š${types}` : ""}ã€‚</div>
      <div class="result-detail">${compare}</div>
      <div class="result-banner">${banner}</div>
      <div class="result-actions">
        <button type="button" onclick="downloadResultImage()">ä¸‹è¼‰çµæœåœ–ç‰‡</button>
        <button type="button" onclick="shareResult(${JSON.stringify(shareText)})">åˆ†äº«çµæœçµ¦è¦ªå‹</button>
      </div>
    `;

    const payload = {
      timestamp: new Date().toISOString(),
      age,
      city,
      types,
      spent,
      won,
      net,
      roi,
      nickname: randomTitle,
    };

    try {
      await fetch(SHEET_ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      console.warn("å¯«å…¥ Google Sheets å¤±æ•—ï¼ˆå…ˆä¸å½±éŸ¿é«”é©—ï¼‰", err);
    }
  });

  showStep(1);
</script>
</body>
</html>
